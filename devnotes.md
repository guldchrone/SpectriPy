# Developer notes

This documents describes the general structure of the package and provides
helpful pointers to code and files for contributors. Ideally, read through the
**full** document.


## General info

**What is this package good for?**

- The [Spectra]() package (and the `Spectra` class) provides a powerful
  infrastructure for mass spectrometry (MS) data in R (see eventually the
  [SpectraTutorials](https://jorainer.github.io/SpectraTutorials/) for more
  information, in particular the
  [Spectra-backends](https://jorainer.github.io/SpectraTutorials/articles/Spectra-backends.html)
  vignette for a description of its data structure).

- Powerful MS data algorithms algorithms are also available in Python,
  e.g. provided by the [matchms](https://github.com/matchms/matchms) library.

- Why re-implement what's already available?

- This package *translates* an R `Spectra` object into the *matchms* Python
  `Spectrum` data structure and allows to call functions of the *matchms*
  package, translating the results back into R data objects.


## General package structure

**Where to find what?**

- The *R* folder contains all R source files.

- *R/conversion.R* contains function to convert between R and Python data
  structures (i.e. between `Spectra::Spectra` and `matchms.Spectrum`).

- *R/compareSpectriPy.R* contains the similarity calculation functions. The core
  function is the internal
  [`.compare_spectra_python()`](https://github.com/rformassspectrometry/SpectriPy/blob/main/R/compareSpectriPy.R#L304-L333)
  function that manages the conda/Python environment, translates the data to
  Python data structures and calls the Python command using
  `py_run_string()`. The Python command itself is generated by the
  `python_command()`
  (e.g. [this](https://github.com/rformassspectrometry/SpectriPy/blob/main/R/compareSpectriPy.R#L255-L266))
  call on the *parameter* object
  (e.g. [`CosineGreedyParam`](https://github.com/rformassspectrometry/SpectriPy/blob/main/R/compareSpectriPy.R#L132-L153)). To
  add a new similarity calculation function or a new Python
  functionality/algorithm, ideally, a new *param* object should be implemented
  and it's `python_command()` method, that returns the python command specific
  for the new algorithm/Python functionality to run. The conversion of the
  Python result into an R data type is handled by R's *reticulate* package,
  which can convert all basic data types between R and Python.

- *R/basilisk.R* cointains the Python environment definition and required/used
  libraries (see below for more information).

- The *tests* folder contains all unit tests. A general *testthat.R* file that
  configures and sets the tests up, and one unit test file for each R source
  file (named *test_<R-source-file>.R*) within the *testthat* directory.

- The *vignettes* folder contains an R markdown document explaining the usage of
  the package through examples. This is a great starting point to explore the
  package and its functionality.


## Python setup and configuration

**Where are python libraries defined?**

- *SpectriPy* uses the R *reticulate* package for conversion between (basic) R
  and Python data types.and relies on Bioconductor's
  [*basilisk*](https://bioconductor.org/packages/basilisk) package to setup and
  manage the Python envrionment.

- The Python environment and required libraries are defined in the
  *R/basilisk.R* file. Different environments can be defined in that file with
  the required libraries (including versions).

- To execute Python code from a certain library, the `basiliscRun()` function is
  used, with the respective environment providing this library being enabled
  and disabled with the `basiliskStart()` and `basiliskStop()` functions.

- The *reticulate* `r_to_py()` and `py_to_r()` functions are used for conversion
  of basic data types between R and Python and *vice versa*. To use these
  functions, an Python environment with the *matchms* library must be used (or
  the one defined in *SpectriPy* and managed by *basilisk* needs to be activated
  first using `cl <- basiliskStart(SpectriPy:::matchms_env)` (see package
  vignette for an example).


## Test data

**What data could be used in tests?**

- The package does not contain any test data files. Test and example data are
  created *manually* by defining *m/z* and intensity values of MS peaks. Data
  files could be added (e.g. in MGF format) if needed and put into a
  *inst/extdata* folder.

- Alternatively, example files in mzML format would be available in
  Bioconductor's [*msdata*](https://bioconductor.org/packages/msdata)
  package.

- To test the package and newly created functionality: add the respective unit
  tests to the *tests/testthat* folder and evaluate them e.g. by running
  `rcmdcheck::rcmdcheck(args = "--no-manual")` in an R session started within
  the package folder.


## Potential contributions and extensions

**What could be implemented?**

- Add some new similarity calculation functionality to `SpectriPy`. See also
  [issue #19](https://github.com/rformassspectrometry/SpectriPy/issues/19).

- Integrate other Python libraries? More a discussion - see [issue
  #24](https://github.com/rformassspectrometry/SpectriPy/issues/24).

- Integrate spectra processing/analysis functionality (cleaning, ...). See also
  [issue #20](https://github.com/rformassspectrometry/SpectriPy/issues/20).

- Ability to translate additional data structures. See also [issue
  #18](https://github.com/rformassspectrometry/SpectriPy/issues/18).

- More efficient translation of data structures. Better handling of
  metadata. See also [issue
  #17](https://github.com/rformassspectrometry/SpectriPy/issues/17).

- Improve documentation. See also [issue
  #25](https://github.com/rformassspectrometry/SpectriPy/issues/25).

- Define a use case analysis (or ideally several): show how data can be analyzed
  with the package and contrast that to a quarto document directly combining the
  R and Python code: is there really need for additional convenience
  functionality within an R package, or can the same, or more, be achieved with
  quarto? What are the benefits of *bundling*/wrapping Python functionality in R
  functions? See also [issue
  #21](https://github.com/rformassspectrometry/SpectriPy/issues/21).

- Add some more use cases and examples to the package vignette
  (*vignettes/SpectriPy.Rmd*) file. See also [issue
  #26](https://github.com/rformassspectrometry/SpectriPy/issues/26).


## Contributing

**How to contribute?**

- Ideally fork the github repository, implement extensions and make a pull
  request.

- Follow the [coding stile
  guidelines](https://rformassspectrometry.github.io/RforMassSpectrometry/articles/RforMassSpectrometry.html#coding-style)
  and adhere to the [code of
  conduct](https://rformassspectrometry.github.io/RforMassSpectrometry/articles/RforMassSpectrometry.html#code-of-conduct).
